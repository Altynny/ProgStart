{% extends "layout.html" %}

{% block title %}{{ test.title }} - ProgStart{% endblock %}

{% block content %}
<div class="container test-page-container">
    <div class="test-header">
        <h1 class="test-title">{{ test.title }}</h1>
        <p class="test-progress">
            <span id="current-question">1</span> из <span id="total-questions">{{ test.questions|length }}</span>
        </p>
    </div>
    
    <div class="test-content">
        <form id="test-form" data-test-id="{{ test.id }}">
            {% for question in test.questions %}
                <div class="question-card" id="question-{{ loop.index }}" style="{% if loop.index > 1 %}display: none;{% endif %}">
                    <div class="question-header">
                        <span class="question-number">Вопрос {{ loop.index }}</span>
                    </div>
                    
                    <h3 class="question-text">{{ question.text }}</h3>
                    
                    <div class="options-list">
                        {% for option in question.options %}
                            <div class="option-item">
                                <label class="option-label">
                                    <input
                                        type="radio"
                                        name="question_{{ question.id }}"
                                        value="{{ option.id }}"
                                        data-question-id="{{ question.id }}"
                                        class="option-input"
                                    >
                                    <span class="option-text">{{ option.text }}</span>
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
            
            <div class="navigation-buttons">
                <button type="button" id="prev-btn" class="btn btn-outline nav-btn" disabled>
                    Назад
                </button>
                
                <button type="button" id="next-btn" class="btn nav-btn">
                    Далее
                </button>
                
                <button type="button" id="submit-btn" class="btn btn-success nav-btn" style="display: none;">
                    Завершить тест
                </button>
            </div>
            
            <div class="questions-progress" id="questions-progress">
                {% for question in test.questions %}
                    <div 
                        class="progress-dot {% if loop.index == 1 %}current{% endif %}" 
                        data-question="{{ loop.index }}"
                        title="Вопрос {{ loop.index }}"
                    ></div>
                {% endfor %}
            </div>
        </form>
    </div>
    
    <div id="test-result" class="test-result-container" style="display: none;">
        <h1 class="test-result-title">Результаты теста</h1>
        
        <div class="test-result-card">
            <h2 class="test-name">{{ test.title }}</h2>
            <div class="result-info">
                <p class="result-score">
                    Ваш результат: <span id="score">0</span> из {{ test.questions|length }}
                </p>
                <p class="result-percentage" id="percentage">
                    (0%)
                </p>
            </div>
            
            <div class="result-actions">
                <button id="reset-btn" class="btn btn-outline">
                    Пройти тест снова
                </button>
                <a href="/tests" class="btn">
                    К списку тестов
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Получаем все необходимые элементы
        const form = document.getElementById('test-form');
        const testId = form.dataset.testId;
        const questions = document.querySelectorAll('.question-card');
        const totalQuestions = questions.length;
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const progressDots = document.querySelectorAll('.progress-dot');
        const currentQuestionSpan = document.getElementById('current-question');
        const testContent = document.querySelector('.test-content');
        const testResult = document.getElementById('test-result');
        const scoreSpan = document.getElementById('score');
        const percentageSpan = document.getElementById('percentage');
        const resetBtn = document.getElementById('reset-btn');
        
        // Текущий вопрос
        let currentQuestion = 1;
        
        // Ответы пользователя
        const answers = {};
        
        // Функция для проверки, выбран ли ответ для текущего вопроса
        function isCurrentQuestionAnswered() {
            const questionId = questions[currentQuestion - 1].querySelector('input').dataset.questionId;
            return answers[questionId] !== undefined;
        }
        
        // Функция для обновления состояния кнопок навигации
        function updateNavButtons() {
            prevBtn.disabled = currentQuestion === 1;
            
            if (currentQuestion === totalQuestions) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
                
                // Проверяем, все ли вопросы отвечены
                let allAnswered = true;
                for (let i = 0; i < totalQuestions; i++) {
                    const inputs = questions[i].querySelectorAll('input');
                    const questionId = inputs[0].dataset.questionId;
                    if (answers[questionId] === undefined) {
                        allAnswered = false;
                        break;
                    }
                }
                
                submitBtn.disabled = !allAnswered;
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
                nextBtn.disabled = !isCurrentQuestionAnswered();
            }
        }
        
        // Функция для перехода к вопросу
        function goToQuestion(questionNumber) {
            // Скрываем все вопросы
            for (let i = 0; i < questions.length; i++) {
                questions[i].style.display = 'none';
                progressDots[i].classList.remove('current');
            }
            
            // Показываем выбранный вопрос
            questions[questionNumber - 1].style.display = 'block';
            progressDots[questionNumber - 1].classList.add('current');
            
            // Обновляем текущий вопрос
            currentQuestion = questionNumber;
            currentQuestionSpan.textContent = currentQuestion;
            
            // Обновляем кнопки навигации
            updateNavButtons();
            
            // Прокручиваем страницу вверх
            window.scrollTo(0, 0);
        }
        
        // Обработчик выбора ответа
        form.addEventListener('change', function(e) {
            if (e.target.matches('input[type="radio"]')) {
                const questionId = e.target.dataset.questionId;
                const optionId = parseInt(e.target.value);
                
                // Сохраняем ответ
                answers[questionId] = optionId;
                
                // Отмечаем вопрос как отвеченный
                const questionIndex = Array.from(questions).findIndex(q => 
                    q.querySelector('input').dataset.questionId === questionId
                );
                progressDots[questionIndex].classList.add('answered');
                
                // Обновляем состояние кнопок
                updateNavButtons();
            }
        });
        
        // Обработчик кнопки "Далее"
        nextBtn.addEventListener('click', function() {
            if (currentQuestion < totalQuestions) {
                goToQuestion(currentQuestion + 1);
            }
        });
        
        // Обработчик кнопки "Назад"
        prevBtn.addEventListener('click', function() {
            if (currentQuestion > 1) {
                goToQuestion(currentQuestion - 1);
            }
        });
        
        // Обработчик клика по точкам прогресса
        document.getElementById('questions-progress').addEventListener('click', function(e) {
            if (e.target.matches('.progress-dot')) {
                const questionNumber = parseInt(e.target.dataset.question);
                goToQuestion(questionNumber);
            }
        });
        
        // Обработчик отправки теста
        submitBtn.addEventListener('click', async function() {
            // Преобразуем ответы в формат для отправки
            const answersArray = Object.entries(answers).map(([questionId, optionId]) => ({
                question_id: parseInt(questionId),
                selected_option_id: optionId
            }));
            
            try {
                console.log('Отправляем ответы:', JSON.stringify({ answers: answersArray }));
                
                // Отправляем ответы на сервер
                const response = await fetch(`/tests/${testId}/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ answers: answersArray }),
                    credentials: 'include'  // Важно для отправки куки
                });
                
                const responseData = await response.json();
                console.log('Ответ от сервера:', responseData);
                
                if (response.ok) {
                    // Показываем результаты
                    scoreSpan.textContent = responseData.score;
                    const percentage = Math.round((responseData.score / totalQuestions) * 100);
                    percentageSpan.textContent = `(${percentage}%)`;
                    
                    // Скрываем тест и показываем результаты
                    testContent.style.display = 'none';
                    testResult.style.display = 'block';
                } else {
                    alert(`Ошибка: ${responseData.detail || 'Произошла ошибка при отправке ответов'}`);
                }
            } catch (error) {
                console.error('Ошибка при отправке ответов:', error);
                alert('Произошла ошибка при отправке ответов. Проверьте консоль для деталей.');
            }
        });
        
        // Обработчик кнопки "Пройти тест снова"
        resetBtn.addEventListener('click', function() {
            // Сбрасываем ответы
            for (const key in answers) {
                delete answers[key];
            }
            
            // Сбрасываем выбранные радиокнопки
            const radioButtons = form.querySelectorAll('input[type="radio"]');
            for (const radio of radioButtons) {
                radio.checked = false;
            }
            
            // Сбрасываем отметки о прохождении
            for (const dot of progressDots) {
                dot.classList.remove('answered');
            }
            
            // Возвращаемся к первому вопросу
            goToQuestion(1);
            
            // Скрываем результаты и показываем тест
            testResult.style.display = 'none';
            testContent.style.display = 'block';
        });
        
        // Инициализация
        updateNavButtons();
    });
</script>
{% endblock %}
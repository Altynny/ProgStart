{% extends "admin/layout.html" %}

{% block admin_title %}Управление тестами - Панель администратора{% endblock %}

{% block admin_page_title %}Управление тестами{% endblock %}

{% block admin_content %}
<div class="admin-tests-container">
    <div class="admin-actions">
        <a href="/admin/tests/create" class="btn btn-success">Создать тест</a>
    </div>
    
    <div class="admin-table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Название</th>
                    <th>Описание</th>
                    <th>Вопросов</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for test in tests %}
                    <tr data-test-id="{{ test.id }}">
                        <td>{{ test.id }}</td>
                        <td>{{ test.title }}</td>
                        <td>{{ test.description or 'Нет описания' }}</td>
                        <td>{{ test.questions|length }}</td>
                        <td class="admin-actions-cell">
                            <a href="/admin/tests/{{ test.id }}/edit" class="admin-btn-edit">Редактировать</a>
                            <button class="admin-btn-delete" data-test-id="{{ test.id }}">Удалить</button>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="5" class="admin-no-data">Нет доступных тестов</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Модальное окно для подтверждения удаления -->
<div id="delete-modal" class="admin-modal">
    <div class="admin-modal-content">
        <span class="admin-modal-close">&times;</span>
        <h2>Подтверждение удаления</h2>
        <p>Вы уверены, что хотите удалить этот тест? Это действие приведет к удалению всех связанных вопросов и результатов прохождения. Эта операция необратима.</p>
        <input type="hidden" id="delete-test-id" value="">
        <div class="admin-form-buttons">
            <button type="button" class="btn admin-btn-cancel">Отмена</button>
            <button type="button" class="btn btn-danger admin-btn-confirm-delete">Удалить</button>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Элементы модального окна
        const deleteModal = document.getElementById('delete-modal');
        const deleteBtns = document.querySelectorAll('.admin-btn-delete');
        const closeBtns = document.querySelectorAll('.admin-modal-close');
        const cancelBtns = document.querySelectorAll('.admin-btn-cancel');
        const confirmDeleteBtn = document.querySelector('.admin-btn-confirm-delete');
        
        // Обработчики для кнопок удаления
        deleteBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const testId = this.dataset.testId;
                document.getElementById('delete-test-id').value = testId;
                deleteModal.style.display = 'block';
            });
        });
        
        // Закрытие модального окна при клике на крестик или кнопку отмены
        closeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                deleteModal.style.display = 'none';
            });
        });
        
        cancelBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                deleteModal.style.display = 'none';
            });
        });
        
        // Закрытие модального окна при клике вне его области
        window.addEventListener('click', function(event) {
            if (event.target === deleteModal) {
                deleteModal.style.display = 'none';
            }
        });
        
        // Подтверждение удаления теста
        confirmDeleteBtn.addEventListener('click', async function() {
            const testId = document.getElementById('delete-test-id').value;
            
            try {
                const response = await fetch(`/admin/tests/${testId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    // Закрываем модальное окно и обновляем страницу
                    deleteModal.style.display = 'none';
                    window.location.reload();
                } else {
                    const error = await response.json();
                    alert(`Ошибка: ${error.detail || 'Произошла ошибка при удалении теста'}`);
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при удалении теста');
            }
        });
    });
</script>
{% endblock %}